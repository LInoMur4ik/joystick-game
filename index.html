<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Мультитач Джойстики</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: space-around;
            align-items: center;
            height: 100vh;
            background-color: #121212;
            touch-action: none;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
        }

        .joystick-container {
            width: 160px;
            height: 160px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .stick {
            width: 60px;
            height: 60px;
            background: #ff007b; /* Розовый для левого */
            border-radius: 50%;
            position: absolute;
            pointer-events: none; /* Чтобы клик проходил сквозь стик на базу */
            box-shadow: 0 0 20px rgba(255, 0, 123, 0.4);
        }

        #right-base .stick {
            background: #00d4ff; /* Голубой для правого */
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.4);
        }

        .label {
            position: absolute;
            bottom: -40px;
            color: #777;
            text-transform: uppercase;
            font-size: 10px;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <div class="joystick-container" id="left-base">
        <div class="stick" id="left-stick"></div>
        <div class="label">Движение</div>
    </div>

    <div class="joystick-container" id="right-base">
        <div class="stick" id="right-stick"></div>
        <div class="label">Камера</div>
    </div>

    <script>
        class Joystick {
            constructor(baseId, stickId) {
                this.base = document.getElementById(baseId);
                this.stick = document.getElementById(stickId);
                this.maxRadius = this.base.offsetWidth / 2;
                
                this.activeTouchId = null; // Храним ID пальца
                this.value = { x: 0, y: 0 };

                // Слушаем события на БАЗЕ (чтобы работало нажатие в любую точку зоны)
                this.base.addEventListener('touchstart', (e) => this.handleStart(e), { passive: false });
                window.addEventListener('touchmove', (e) => this.handleMove(e), { passive: false });
                window.addEventListener('touchend', (e) => this.handleEnd(e));
                
                // Поддержка мышки
                this.base.addEventListener('mousedown', (e) => this.handleStart(e));
                window.addEventListener('mousemove', (e) => this.handleMove(e));
                window.addEventListener('mouseup', () => this.handleEnd(null));
            }

            handleStart(e) {
                if (this.activeTouchId !== null) return;

                if (e.touches) {
                    // Берем то касание, которое произошло именно в зоне этой базы
                    const touch = Array.from(e.changedTouches).find(t => 
                        document.elementFromPoint(t.clientX, t.clientY) === this.base
                    );
                    if (!touch) return;
                    this.activeTouchId = touch.identifier;
                    this.updatePosition(touch.clientX, touch.clientY);
                } else {
                    this.activeTouchId = 'mouse';
                    this.updatePosition(e.clientX, e.clientY);
                }
                
                this.stick.style.transition = 'none';
            }

            handleMove(e) {
                if (this.activeTouchId === null) return;

                let input;
                if (e.touches) {
                    input = Array.from(e.touches).find(t => t.identifier === this.activeTouchId);
                } else if (this.activeTouchId === 'mouse') {
                    input = e;
                }

                if (input) {
                    if (e.cancelable) e.preventDefault();
                    this.updatePosition(input.clientX, input.clientY);
                }
            }

            handleEnd(e) {
                if (e && e.touches) {
                    const touch = Array.from(e.changedTouches).find(t => t.identifier === this.activeTouchId);
                    if (!touch) return;
                }
                
                this.activeTouchId = null;
                this.stick.style.transition = 'transform 0.15s ease-out';
                this.stick.style.transform = 'translate(0, 0)';
                this.value = { x: 0, y: 0 };
            }

            updatePosition(clientX, clientY) {
                const rect = this.base.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;

                let dx = clientX - centerX;
                let dy = clientY - centerY;

                const distance = Math.sqrt(dx * dx + dy * dy);
                if (distance > this.maxRadius) {
                    const angle = Math.atan2(dy, dx);
                    dx = Math.cos(angle) * this.maxRadius;
                    dy = Math.sin(angle) * this.maxRadius;
                }

                this.stick.style.transform = `translate(${dx}px, ${dy}px)`;
                this.value.x = dx / this.maxRadius;
                this.value.y = dy / this.maxRadius;
            }
        }

        // Запуск
        const leftJoy = new Joystick('left-base', 'left-stick');
        const rightJoy = new Joystick('right-base', 'right-stick');
    </script>
</body>
</html>
